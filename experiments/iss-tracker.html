<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Live Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            width: 600px;
            height: 500px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 10px;
            text-align: center;
        }

        h1 {
            font-size: 1.1rem;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .info-panel {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: nowrap;
            margin-top: 3px;
        }

        .info-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 12px;
            border-radius: 4px;
            backdrop-filter: blur(10px);
        }

        .info-label {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: bold;
            color: #00ff88;
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .status {
            position: absolute;
            top: 60px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .status.online {
            border-left: 4px solid #00ff88;
        }

        .status.offline {
            border-left: 4px solid #ff0044;
        }

        .iss-icon {
            width: 40px;
            height: 40px;
        }

        .iss-marker {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .trail-line {
            stroke: #00ff88;
            stroke-width: 2;
            fill: none;
            opacity: 0.6;
        }

        footer {
            background: rgba(0, 0, 0, 0.5);
            padding: 3px;
            text-align: center;
            font-size: 0.6rem;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <header>
        <h1>üõ∞Ô∏è International Space Station Live Tracker</h1>
        <div class="info-panel">
            <div class="info-item">
                <div class="info-label">CREW</div>
                <div class="info-value" id="crew">Loading...</div>
            </div>
            <div class="info-item">
                <div class="info-label">ALTITUDE</div>
                <div class="info-value" id="altitude">~408 km</div>
            </div>
            <div class="info-item">
                <div class="info-label">LOCATION</div>
                <div class="info-value" id="location">Loading...</div>
            </div>
        </div>
    </header>

    <div class="status online" id="status">
        üü¢ Live Tracking Active
    </div>

    <div id="map"></div>

    <footer>
        Data provided by Open Notify API | Updates every 10 seconds | ISS orbits Earth every ~90 minutes
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const map = L.map('map', {
            center: [0, 0],
            zoom: 7,
            zoomControl: false,
            worldCopyJump: true,
            minZoom: 7,
            maxZoom: 7
        });

        // Add dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        // ISS marker with rotation
        function createISSIcon(rotation = 0) {
            return L.divIcon({
                className: 'iss-marker',
                html: `<div style="font-size: 40px; text-shadow: 0 0 10px #00ff88; transform: rotate(${rotation}deg); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">üõ∞Ô∏è</div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });
        }

        let issMarker = null;
        let currentRotation = 0;
        let issCircle = null;
        let trailCoordinates = [];
        let trailPolyline = null;
        let predictedPolyline = null;
        const maxTrailPoints = 100;

        // Fetch ISS position
        async function updateISSPosition() {
            try {
                const response = await fetch('/api/iss-position');
                const data = await response.json();

                if (data.message === 'success') {
                    const lat = parseFloat(data.iss_position.latitude);
                    const lon = parseFloat(data.iss_position.longitude);

                    // Calculate rotation based on trajectory
                    if (trailCoordinates.length > 0) {
                        const prevCoord = trailCoordinates[trailCoordinates.length - 1];
                        const deltaLat = lat - prevCoord[0];
                        const deltaLon = lon - prevCoord[1];
                        currentRotation = Math.atan2(deltaLon, deltaLat) * (180 / Math.PI);
                    }

                    // Update or create marker
                    if (issMarker) {
                        issMarker.setLatLng([lat, lon]);
                        issMarker.setIcon(createISSIcon(currentRotation));
                        issCircle.setLatLng([lat, lon]);
                        map.setView([lat, lon], 5, { animate: true, duration: 0.5 });
                    } else {
                        issMarker = L.marker([lat, lon], { icon: createISSIcon(currentRotation) }).addTo(map);
                        issMarker.bindPopup('<b>International Space Station</b><br>Orbiting at ~408 km altitude<br>Speed: ~27,600 km/h');

                        issCircle = L.circle([lat, lon], {
                            color: '#00ff88',
                            fillColor: '#00ff88',
                            fillOpacity: 0.1,
                            radius: 2000000 // ~2000 km visibility radius
                        }).addTo(map);

                        map.setView([lat, lon], 5);
                    }

                    // Get location info
                    updateLocation(lat, lon);

                    // Update trail
                    trailCoordinates.push([lat, lon]);
                    if (trailCoordinates.length > maxTrailPoints) {
                        trailCoordinates.shift();
                    }

                    if (trailPolyline) {
                        map.removeLayer(trailPolyline);
                    }

                    trailPolyline = L.polyline(trailCoordinates, {
                        color: '#00ff88',
                        weight: 3,
                        opacity: 0.8,
                        smoothFactor: 1
                    }).addTo(map);

                    // Calculate and draw predicted trajectory
                    if (trailCoordinates.length >= 2) {
                        const predictedPath = calculatePredictedPath(lat, lon, trailCoordinates);

                        if (predictedPolyline) {
                            map.removeLayer(predictedPolyline);
                        }

                        predictedPolyline = L.polyline(predictedPath, {
                            color: '#cccccc',
                            weight: 2,
                            opacity: 0.6,
                            smoothFactor: 1,
                            dashArray: '5, 10'
                        }).addTo(map);
                    }

                    // Update status
                    document.getElementById('status').className = 'status online';
                    document.getElementById('status').innerHTML = 'üü¢ Live Tracking Active';
                }
            } catch (error) {
                console.error('Error fetching ISS position:', error);
                document.getElementById('status').className = 'status offline';
                document.getElementById('status').innerHTML = 'üî¥ Connection Error';
            }
        }

        // Calculate predicted ISS path based on orbital mechanics (sinusoidal pattern)
        function calculatePredictedPath(currentLat, currentLon, trail) {
            const predictedPoints = [[currentLat, currentLon]];
            const numPredictions = 60; // Predict more points to show the sine wave

            if (trail.length < 10) return predictedPoints;

            // ISS orbital parameters
            const orbitalInclination = 51.6; // degrees
            const recent = trail.slice(-10);

            // Calculate average longitude change (roughly linear)
            let avgLonDelta = 0;
            for (let i = 1; i < recent.length; i++) {
                let lonDiff = recent[i][1] - recent[i - 1][1];
                if (lonDiff > 180) lonDiff -= 360;
                if (lonDiff < -180) lonDiff += 360;
                avgLonDelta += lonDiff;
            }
            avgLonDelta /= (recent.length - 1);

            // Estimate current phase and frequency of the sine wave
            // by analyzing latitude pattern
            let latDirection = 0;
            if (recent.length >= 3) {
                const recentLatChange = recent[recent.length - 1][0] - recent[recent.length - 3][0];
                latDirection = recentLatChange;
            }

            // Estimate where we are in the sine wave cycle
            const currentPhase = Math.asin(currentLat / orbitalInclination);

            // The ISS completes ~15.5 orbits per day, so period is about 90 minutes
            // Each prediction is 5 seconds apart
            const periodInPoints = (90 * 60) / 5; // ~1080 points for full orbit
            const angularVelocity = (2 * Math.PI) / periodInPoints;

            // Determine if we're going up or down in latitude
            let direction = latDirection >= 0 ? 1 : -1;
            if (Math.abs(currentLat) > orbitalInclination * 0.95) {
                // Near the peak, we should be turning around
                direction = currentLat > 0 ? -1 : 1;
            }

            // Generate predicted path as sinusoid
            let lon = currentLon;
            let phase = currentPhase;

            for (let i = 1; i <= numPredictions; i++) {
                // Update phase
                phase += direction * angularVelocity;

                // Calculate latitude as sine wave
                let lat = orbitalInclination * Math.sin(phase);

                // Check if we hit the peak and need to reverse direction
                if (Math.abs(lat) > orbitalInclination) {
                    lat = orbitalInclination * Math.sign(lat);
                    direction *= -1;
                }

                // Update longitude (roughly linear)
                lon += avgLonDelta;

                // Wrap longitude
                if (lon > 180) lon -= 360;
                if (lon < -180) lon += 360;

                predictedPoints.push([lat, lon]);
            }

            return predictedPoints;
        }

        // Fetch location information
        async function updateLocation(lat, lon) {
            try {
                const response = await fetch(`/api/reverse-geocode?lat=${lat}&lon=${lon}`);
                const data = await response.json();

                if (data.address) {
                    const country = data.address.country || '';
                    const city = data.address.city || data.address.town || data.address.village || '';
                    const ocean = data.address.ocean || data.address.sea || '';

                    let location = 'Open Ocean';
                    if (city && country) {
                        location = `${city}, ${country}`;
                    } else if (country) {
                        location = country;
                    } else if (ocean) {
                        location = ocean;
                    }

                    document.getElementById('location').textContent = location;
                } else {
                    document.getElementById('location').textContent = 'Open Ocean';
                }
            } catch (error) {
                console.error('Error fetching location:', error);
                document.getElementById('location').textContent = 'Unknown';
            }
        }

        // Fetch crew information
        async function updateCrewInfo() {
            try {
                const response = await fetch('/api/iss-crew');
                const data = await response.json();

                if (data.message === 'success') {
                    const issCrewCount = data.people.filter(p => p.craft === 'ISS').length;
                    document.getElementById('crew').textContent = issCrewCount + ' astronauts';
                }
            } catch (error) {
                console.error('Error fetching crew info:', error);
                document.getElementById('crew').textContent = 'Unknown';
            }
        }

        // Initialize
        updateISSPosition();
        updateCrewInfo();

        // Update ISS position every 10 seconds (6 times per minute)
        setInterval(updateISSPosition, 10000);

        // Update crew info every 60 seconds
        setInterval(updateCrewInfo, 60000);
    </script>
</body>

</html>